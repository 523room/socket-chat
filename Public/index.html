<!DOCTYPE html>
<html>
  <head>
    <title>JV Socket App</title>
    <style>
      body {
        background-color: gold;
      }
      div {
        text-align:left;
        height: 50%;
        width: 50%;
        font-size: 15px;
        background-color: gold;
      }
      input {
        width: 35.1%;
        font-size: 15px;
      }
      button {
        width: 15%;
        font-size: 10px;
      }
      p {
        background-color: gold;
      }
    </style>
  </head>
  <body>
    <center>
    <div id="dataSpace"></div>
    <br>
    <input onkeypress="enter(event)" id="msg" placeholder="Set Your Username">
    <button onclick="sendMessage()" id="btn">Set Username</button>
    </center>
    <div id="connectedUsers">Connected Users :0</div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var username = false;
      var ipAdd = "";
      var msg = document.getElementById('msg');
      var msgSpace = document.getElementById('dataSpace');


function getUserIP(onNewIP) {
    var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    var pc = new myPeerConnection({
        iceServers: []
    }),
    noop = function() {},
    localIPs = {},
    ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g,
    key;

    function iterateIP(ip) {
        if (!localIPs[ip]) onNewIP(ip);
        localIPs[ip] = true;
    }

     //create a bogus data channel
    pc.createDataChannel("");

    // create offer and set local description
    pc.createOffer().then(function(sdp) {
        sdp.sdp.split('\n').forEach(function(line) {
            if (line.indexOf('candidate') < 0) return;
            line.match(ipRegex).forEach(iterateIP);
        });

        pc.setLocalDescription(sdp, noop, noop);
    }).catch(function(reason) {
        // An error occurred, so handle the failure to connect
    });

    //listen for candidate events
    pc.onicecandidate = function(ice) {
        if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
        ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
    };
}
getUserIP(function(ipip){
  ipAdd = ipip;
});
      socket.emit('ipSeConfig', ipAdd);
      socket.on('broadcast', function(data){
        if (data.desc.indexOf("<b>@"+username)==0) {
          msgSpace.innerHTML += '<p align="right">' + data.desc + "</p><br>";
        } else {
          msgSpace.innerHTML += '<p align="left">' + data.desc + "</p><br>";
        }
      });
      socket.on('val', function(data){
        if (data.val == false) {
          msgSpace.innerHTML = "Please Choose another UserName";
        } else {
          username = data.val;
          socket.emit('broadcast_name', username);
          document.getElementById('btn').innerHTML = "Send Message";
          msgSpace.innerHTML += "<center><i>You are logged in as " + username + "<br></i></center>";
          msg.placeholder = "Type your message here";
        }
      });

      function enter(event) {
        var key = event.which || event.keyCode;
        if (key == 13) {
          sendMessage();
        }
      }

      function sendMessage() {
      alert(msg.value);
        if (username == false) {
          socket.emit('setUserName', {username: msg.value, ip:ipAdd});
        } else {
          socket.emit('message', {desc:"<b>@"+username+":</b> "+msg.value});
        }
          msg.value = "";
      }
    </script>
  </body>
</html>
